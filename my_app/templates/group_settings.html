{% extends "base.html" %} 

{% block content %}
{% load static %}

  <h2 class="group-header-settings">Group: {{ group.name }}</h2>
  <h2 class="group-members-settings">Group Members:</h2>


  <div class="table-container" style="margin: 5px">
    <table class="styled-table">
        <tr>
            <th>Member</th>
            <th>Role</th>
            <th>Options</th>
        </tr>
        {% for member in members %}
            <tr>
                <th>{{ member.username }}</th>
                  {% if admin == user %}

                  
                    {% if member != user %}
                    <th>
                      Member
                    </th>

                      <th class="make-inline">
                      <form id="promote-admin-form{{ member.username }}" action="{% url 'promote_to_admin' userToPromote=member.id %}" method="post">
                        {% csrf_token %}
                            <button type="button" class="set-admin-btn" onclick="confirmSetAdmin('{{ member.username }}')">Set Admin</button>
                      </form>
                      <form id="remove-member-form{{ member.username }}" action="{% url 'remove_member' userToRemove=member.id %}" method="post">
                        {% csrf_token %}
                            <button type="button" class="remove-member-btn" onclick="confirmRemoveMember('{{ member.username }}')">Remove</button>
                      </form>
                      </th>
                    
                    {% else %}
                    <th>
                      Admin
                    </th>
                      <th>

                      </th>
                    {% endif %}



                  {% else %}
                    {% if member == admin %}
                    <th>
                      Admin
                    </th>
                      <th>

                      </th>
                    {% else %}
                      <th>
                        Member
                      </th>
                        <th>

                        </th>
                    {% endif %}



                  {% endif %}

            </tr>
        {% endfor %}
    </table>
  </div>
  {% include "components/optin.html" %}


  {% if user != admin %}
    <form id="leave-group-form" style="display: flex; justify-content: center;" action="{% url 'leave_group' %}" method="post">
      {% csrf_token %}
    <button class="group-settings-button" type="button" onclick="confirmLeave()">Leave Group</button>
    </form>
  {% else %}
    <div>
      <button id="showInvLink">Generate Invite Link</button>
      <div id="hiddenInvLink" class="hiddenInvLink">Join Group Link: http://127.0.0.1:8000/groups/join/{{ group.id }}/</div>
    </div>

    <form id="delete-group-form" style="display: flex; justify-content: center;" action="{% url 'delete_group' group.id %}" method="post">
      {% csrf_token %}
      <button type="button" class="group-settings-button" onclick="confirmDelete()">Delete Group</button>
    </form>
    
  {% endif %}
  
{% block messages %}
  {% if messages %}
    <script>
      // JavaScript to show alert box with messages
      window.onload = function() {
        alert("{% for message in messages %}{{ message }}\n{% endfor %}");
      };
    </script>
  {% endif %}
{% endblock %}

<script>
  document.getElementById('showInvLink').addEventListener('click', function() {
    var hiddenElement = document.getElementById('hiddenInvLink');
    var toggleButton = document.getElementById('showInvLink');
    
    if (hiddenElement.classList.contains('hiddenInvLink')) {
      hiddenElement.classList.remove('hiddenInvLink');
      hiddenElement.classList.add('visible');
      toggleButton.textContent = 'Hide Invite Link';
    } else {
      hiddenElement.classList.remove('visible');
      hiddenElement.classList.add('hiddenInvLink');
      toggleButton.textContent = 'Generate Invite Link';
    }
  });
  function confirmDelete() {
    if (confirm("Are you sure you want to delete this group?")) {
      document.getElementById("delete-group-form").submit();
    }
  }
  function confirmLeave() {
    if (confirm("Are you sure you want to leave this group?")) {
      document.getElementById("leave-group-form").submit();
    }
  }
  function confirmSetAdmin(mem) {
    if (confirm("Are you sure you want to promote "+mem+" to admin of this group?")) {
      document.getElementById("promote-admin-form"+mem).submit();
    }
  }
  function confirmRemoveMember(mem) {
    if (confirm("Are you sure you want to remove "+mem+" from the group?")) {
      document.getElementById("remove-member-form"+mem).submit();
    }
  }

  document.addEventListener("DOMContentLoaded", function() {
    const toggleButton = document.getElementById("toggleButton");

    toggleButton.addEventListener("change", function() {
        const isChecked = this.checked;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/update_toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'isChecked': isChecked
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            console.log(data); // Log response from server
        }).catch(error => {
            console.error('There was a problem with your fetch operation:', error);
        });
    });
});

</script>
  
{% comment %} {% else %}
  <p>Not admin group</p>
  {% comment %} <p>{{  }}</p>
{% endif %} {% endcomment %}

{% endblock %}
{% extends "base.html" %} 

{% block content %}
{% load static %}

  <h2 class="group-header-settings">Group: {{ group.name }}</h2>
  <h2 class="group-members-settings">Group Members:</h2>

  <div class="table-container">
    <table class="styled-table">
        <tr>
            <th>Member</th>
            <th>Role</th>
            <th>Options</th>
        </tr>
        {% for member in members %}
            <tr>
                <th>{{ member.username }}</th>
                  {% if admin == user %}

                  
                    {% if member != user %}
                    <th>
                      Member
                    </th>

                      <th class="make-inline">
                      <form id="promote-admin-form{{ member.username }}" action="{% url 'promote_to_admin' userToPromote=member.id %}" method="post">
                        {% csrf_token %}
                            <button type="button" class="set-admin-btn" onclick="confirmSetAdmin('{{ member.username }}')">Set Admin</button>
                      </form>
                      <form id="remove-member-form{{ member.username }}" action="{% url 'remove_member' userToRemove=member.id %}" method="post">
                        {% csrf_token %}
                            <button type="button" class="remove-member-btn" onclick="confirmRemoveMember('{{ member.username }}')">Remove</button>
                      </form>
                      </th>
                    
                    {% else %}
                    <th>
                      Admin
                    </th>
                      <th>

                      </th>
                    {% endif %}



                  {% else %}
                    {% if member == admin %}
                    <th>
                      Admin
                    </th>
                      <th>

                      </th>
                    {% else %}
                      <th>
                        Member
                      </th>
                        <th>

                        </th>
                    {% endif %}



                  {% endif %}

            </tr>
        {% endfor %}
    </table>
  </div>
  
  {% include "components/optin.html" %}

  <div style="text-align: center;">
    <button styles="justify-content: center;" class="group-settings-button" id="popupBtn">Generate Invite Link</button>
  </div>
  <div id="modal" class="modal">
      <div class="modal-content">
          <div>Shareable link to join group: {{ group.name }}</div>
          <br></br>
          <div id="popupText">http://127.0.0.1:8000/groups/join/{{ group.id }}/{{ encrypted_password }}/</div>
          <button id="copyBtn">Copy to Clipboard</button>
      </div>
  </div>

  <br></br>

  {% if user != admin %}
    <form id="leave-group-form" style="display: flex; justify-content: center;" action="{% url 'leave_group' %}" method="post">
      {% csrf_token %}
    <button class="group-settings-button" type="button" onclick="confirmLeave()">Leave Group</button>
    </form>
  {% else %}
    <form id="delete-group-form" style="display: flex; justify-content: center;" action="{% url 'delete_group' group.id %}" method="post">
      {% csrf_token %}
      <button type="button" class="group-settings-button" onclick="confirmDelete()">Delete Group</button>
    </form>
    
  {% endif %}
  
{% block messages %}
  {% if messages %}
    <script>
      // JavaScript to show alert box with messages
      window.onload = function() {
        alert("{% for message in messages %}{{ message }}\n{% endfor %}");
      };
    </script>
  {% endif %}
{% endblock %}

<script>

  document.addEventListener('DOMContentLoaded', function() {
    var popupBtn = document.getElementById('popupBtn');
    var modal = document.getElementById('modal');
    var copyBtn = document.getElementById('copyBtn');
    var popupText = document.getElementById('popupText');

    popupBtn.addEventListener('click', function() {
        modal.style.display = 'block';
    });

    copyBtn.addEventListener('click', function() {
        var textToCopy = popupText.textContent;
        navigator.clipboard.writeText(textToCopy)
            .then(function() {
                alert('Text copied to clipboard!');
            })
            .catch(function(err) {
                console.error('Unable to copy text: ', err);
            });
    });

    // Close the modal when the user clicks outside of it
    window.addEventListener('click', function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
  });

  function confirmDelete() {
    if (confirm("Are you sure you want to delete this group?")) {
      document.getElementById("delete-group-form").submit();
    }
  }
  function confirmLeave() {
    if (confirm("Are you sure you want to leave this group?")) {
      document.getElementById("leave-group-form").submit();
    }
  }
  function confirmSetAdmin(mem) {
    if (confirm("Are you sure you want to promote "+mem+" to admin of this group?")) {
      document.getElementById("promote-admin-form"+mem).submit();
    }
  }
  function confirmRemoveMember(mem) {
    if (confirm("Are you sure you want to remove "+mem+" from the group?")) {
      document.getElementById("remove-member-form"+mem).submit();
    }
  }

  document.addEventListener("DOMContentLoaded", function() {
    const toggleButton = document.getElementById("toggleButton");

    toggleButton.addEventListener("change", function() {
        const isChecked = this.checked;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('/update_toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'isChecked': isChecked
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            console.log(data); // Log response from server
        }).catch(error => {
            console.error('There was a problem with your fetch operation:', error);
        });
    });
});

</script>
  
{% comment %} {% else %}
  <p>Not admin group</p>
  {% comment %} <p>{{  }}</p>
{% endif %} {% endcomment %}

{% endblock %}